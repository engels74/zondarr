"""initial

Revision ID: 51d23bb57699
Revises:
Create Date: 2026-02-28 15:38:56.635702
"""

from collections.abc import Sequence

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import sqlite

# Revision identifiers, used by Alembic.
revision: str = "51d23bb57699"
down_revision: str | None = None
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Apply migration changes."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "admin_accounts",
        sa.Column("username", sa.String(length=32), nullable=False),
        sa.Column("password_hash", sa.String(length=255), nullable=True),
        sa.Column("email", sa.String(length=255), nullable=True),
        sa.Column("auth_method", sa.String(length=50), nullable=False),
        sa.Column("external_id", sa.String(length=255), nullable=True),
        sa.Column("enabled", sa.Boolean(), nullable=False),
        sa.Column("last_login_at", sa.DateTime(), nullable=True),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    with op.batch_alter_table("admin_accounts", schema=None) as batch_op:
        batch_op.create_index(
            "ix_admin_accounts_external_id", ["external_id"], unique=False
        )
        batch_op.create_index(
            batch_op.f("ix_admin_accounts_username"), ["username"], unique=True
        )

    op.create_table(
        "app_settings",
        sa.Column("key", sa.String(length=255), nullable=False),
        sa.Column("value", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint("key"),
    )
    op.create_table(
        "identities",
        sa.Column("display_name", sa.String(length=255), nullable=False),
        sa.Column("email", sa.String(length=255), nullable=True),
        sa.Column("expires_at", sa.DateTime(), nullable=True),
        sa.Column("enabled", sa.Boolean(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_table(
        "media_servers",
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("server_type", sa.String(length=50), nullable=False),
        sa.Column("url", sa.String(length=2048), nullable=False),
        sa.Column("api_key", sa.String(length=512), nullable=False),
        sa.Column("enabled", sa.Boolean(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_table(
        "wizards",
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("enabled", sa.Boolean(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_table(
        "invitations",
        sa.Column("code", sa.String(length=20), nullable=False),
        sa.Column("expires_at", sa.DateTime(), nullable=True),
        sa.Column("max_uses", sa.Integer(), nullable=True),
        sa.Column("use_count", sa.Integer(), nullable=False),
        sa.Column("duration_days", sa.Integer(), nullable=True),
        sa.Column("enabled", sa.Boolean(), nullable=False),
        sa.Column("created_by", sa.String(length=255), nullable=True),
        sa.Column("pre_wizard_id", sa.Uuid(), nullable=True),
        sa.Column("post_wizard_id", sa.Uuid(), nullable=True),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.CheckConstraint(
            "max_uses IS NULL OR use_count <= max_uses",
            name="ck_invitations_use_count_le_max_uses",
        ),
        sa.ForeignKeyConstraint(
            ["post_wizard_id"], ["wizards.id"], ondelete="SET NULL"
        ),
        sa.ForeignKeyConstraint(["pre_wizard_id"], ["wizards.id"], ondelete="SET NULL"),
        sa.PrimaryKeyConstraint("id"),
    )
    with op.batch_alter_table("invitations", schema=None) as batch_op:
        batch_op.create_index(batch_op.f("ix_invitations_code"), ["code"], unique=True)

    op.create_table(
        "libraries",
        sa.Column("media_server_id", sa.Uuid(), nullable=False),
        sa.Column("external_id", sa.String(length=255), nullable=False),
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("library_type", sa.String(length=50), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(
            ["media_server_id"],
            ["media_servers.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_table(
        "refresh_tokens",
        sa.Column("admin_account_id", sa.Uuid(), nullable=False),
        sa.Column("token_hash", sa.String(length=64), nullable=False),
        sa.Column("expires_at", sa.DateTime(), nullable=False),
        sa.Column("revoked", sa.Boolean(), nullable=False),
        sa.Column("user_agent", sa.String(length=512), nullable=True),
        sa.Column("ip_address", sa.String(length=45), nullable=True),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(
            ["admin_account_id"], ["admin_accounts.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    with op.batch_alter_table("refresh_tokens", schema=None) as batch_op:
        batch_op.create_index(
            batch_op.f("ix_refresh_tokens_token_hash"), ["token_hash"], unique=False
        )

    op.create_table(
        "sync_exclusions",
        sa.Column("external_user_id", sa.String(length=255), nullable=False),
        sa.Column("media_server_id", sa.Uuid(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(
            ["media_server_id"],
            ["media_servers.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "external_user_id",
            "media_server_id",
            name="uq_sync_exclusions_external_user_server",
        ),
    )
    with op.batch_alter_table("sync_exclusions", schema=None) as batch_op:
        batch_op.create_index(
            "ix_sync_exclusions_external_user_id", ["external_user_id"], unique=False
        )

    op.create_table(
        "sync_runs",
        sa.Column("media_server_id", sa.Uuid(), nullable=False),
        sa.Column("sync_type", sa.String(length=32), nullable=False),
        sa.Column("trigger", sa.String(length=32), nullable=False),
        sa.Column("status", sa.String(length=32), nullable=False),
        sa.Column("started_at", sa.DateTime(), nullable=False),
        sa.Column("finished_at", sa.DateTime(), nullable=False),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.CheckConstraint(
            "sync_type IN ('libraries', 'users')",
            name="ck_sync_runs_sync_type",
        ),
        sa.CheckConstraint(
            "trigger IN ('automatic', 'manual', 'onboarding')",
            name="ck_sync_runs_trigger",
        ),
        sa.CheckConstraint(
            "status IN ('success', 'failed')",
            name="ck_sync_runs_status",
        ),
        sa.ForeignKeyConstraint(
            ["media_server_id"], ["media_servers.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    with op.batch_alter_table("sync_runs", schema=None) as batch_op:
        batch_op.create_index(
            "ix_sync_runs_media_server_id", ["media_server_id"], unique=False
        )
        batch_op.create_index(
            "ix_sync_runs_server_type_started",
            ["media_server_id", "sync_type", "started_at"],
            unique=False,
        )

    op.create_table(
        "wizard_steps",
        sa.Column("wizard_id", sa.Uuid(), nullable=False),
        sa.Column("step_order", sa.Integer(), nullable=False),
        sa.Column("title", sa.String(length=255), nullable=False),
        sa.Column("content_markdown", sa.Text(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(["wizard_id"], ["wizards.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint("wizard_id", "step_order", name="uq_wizard_step_order"),
    )
    op.create_table(
        "invitation_libraries",
        sa.Column("invitation_id", sa.Uuid(), nullable=False),
        sa.Column("library_id", sa.Uuid(), nullable=False),
        sa.ForeignKeyConstraint(
            ["invitation_id"],
            ["invitations.id"],
        ),
        sa.ForeignKeyConstraint(
            ["library_id"],
            ["libraries.id"],
        ),
        sa.PrimaryKeyConstraint("invitation_id", "library_id"),
    )
    op.create_table(
        "invitation_servers",
        sa.Column("invitation_id", sa.Uuid(), nullable=False),
        sa.Column("media_server_id", sa.Uuid(), nullable=False),
        sa.ForeignKeyConstraint(
            ["invitation_id"],
            ["invitations.id"],
        ),
        sa.ForeignKeyConstraint(
            ["media_server_id"],
            ["media_servers.id"],
        ),
        sa.PrimaryKeyConstraint("invitation_id", "media_server_id"),
    )
    op.create_table(
        "step_interactions",
        sa.Column("step_id", sa.Uuid(), nullable=False),
        sa.Column("interaction_type", sa.String(length=20), nullable=False),
        sa.Column("config", sqlite.JSON(), nullable=False),
        sa.Column("display_order", sa.Integer(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(["step_id"], ["wizard_steps.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "step_id", "interaction_type", name="uq_step_interaction_type"
        ),
    )
    op.create_table(
        "users",
        sa.Column("identity_id", sa.Uuid(), nullable=False),
        sa.Column("media_server_id", sa.Uuid(), nullable=False),
        sa.Column("invitation_id", sa.Uuid(), nullable=True),
        sa.Column("external_user_id", sa.String(length=255), nullable=False),
        sa.Column("username", sa.String(length=255), nullable=False),
        sa.Column("external_user_type", sa.String(length=50), nullable=True),
        sa.Column("expires_at", sa.DateTime(), nullable=True),
        sa.Column("enabled", sa.Boolean(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(),
            server_default=sa.text("(CURRENT_TIMESTAMP)"),
            nullable=False,
        ),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(
            ["identity_id"],
            ["identities.id"],
        ),
        sa.ForeignKeyConstraint(
            ["invitation_id"], ["invitations.id"], ondelete="SET NULL"
        ),
        sa.ForeignKeyConstraint(
            ["media_server_id"],
            ["media_servers.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "external_user_id", "media_server_id", name="uq_users_external_user_server"
        ),
    )
    with op.batch_alter_table("users", schema=None) as batch_op:
        batch_op.create_index(
            "ix_users_enabled_expires", ["enabled", "expires_at"], unique=False
        )
        batch_op.create_index("ix_users_identity_id", ["identity_id"], unique=False)
        batch_op.create_index(
            batch_op.f("ix_users_invitation_id"), ["invitation_id"], unique=False
        )
        batch_op.create_index(
            "ix_users_media_server_id", ["media_server_id"], unique=False
        )

    # ### end Alembic commands ###


def downgrade() -> None:
    """Revert migration changes."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("users", schema=None) as batch_op:
        batch_op.drop_index("ix_users_media_server_id")
        batch_op.drop_index(batch_op.f("ix_users_invitation_id"))
        batch_op.drop_index("ix_users_identity_id")
        batch_op.drop_index("ix_users_enabled_expires")

    op.drop_table("users")
    op.drop_table("step_interactions")
    op.drop_table("invitation_servers")
    op.drop_table("invitation_libraries")
    op.drop_table("wizard_steps")
    with op.batch_alter_table("sync_runs", schema=None) as batch_op:
        batch_op.drop_index("ix_sync_runs_server_type_started")
        batch_op.drop_index("ix_sync_runs_media_server_id")

    op.drop_table("sync_runs")
    with op.batch_alter_table("sync_exclusions", schema=None) as batch_op:
        batch_op.drop_index("ix_sync_exclusions_external_user_id")

    op.drop_table("sync_exclusions")
    with op.batch_alter_table("refresh_tokens", schema=None) as batch_op:
        batch_op.drop_index(batch_op.f("ix_refresh_tokens_token_hash"))

    op.drop_table("refresh_tokens")
    op.drop_table("libraries")
    with op.batch_alter_table("invitations", schema=None) as batch_op:
        batch_op.drop_index(batch_op.f("ix_invitations_code"))

    op.drop_table("invitations")
    op.drop_table("wizards")
    op.drop_table("media_servers")
    op.drop_table("identities")
    op.drop_table("app_settings")
    with op.batch_alter_table("admin_accounts", schema=None) as batch_op:
        batch_op.drop_index(batch_op.f("ix_admin_accounts_username"))
        batch_op.drop_index("ix_admin_accounts_external_id")

    op.drop_table("admin_accounts")
    # ### end Alembic commands ###
